<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vocal Agent - Voice AI Assistant</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto',
          sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f7;
        min-height: 100vh;
        overflow: hidden;
      }

      /* Integration Button - Top Right */
      .integration-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e0e0e0;
        border-radius: 20px;
        padding: 10px 20px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .integration-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
      }

      /* Main Container */
      .main-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
        padding: 20px;
      }

      /* Welcome Text */
      .welcome-title {
        font-size: 3.5em;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 20px;
        letter-spacing: -0.02em;
      }

      .welcome-subtitle {
        font-size: 1.5em;
        color: #6e6e73;
        margin-bottom: 80px;
        font-weight: 400;
      }

      /* Siri-like Animated Circle */
      .siri-container {
        position: relative;
        margin: 40px 0;
      }

      .siri-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007aff, #5856d6, #af52de, #ff2d92);
        background-size: 300% 300%;
        animation: gradientShift 3s ease-in-out infinite,
          pulse 2s ease-in-out infinite;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 40px rgba(0, 122, 255, 0.3);
      }

      .siri-circle:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 50px rgba(0, 122, 255, 0.4);
      }

      .siri-circle.listening {
        animation: gradientShift 0.5s ease-in-out infinite,
          pulseActive 0.8s ease-in-out infinite;
        box-shadow: 0 15px 60px rgba(0, 122, 255, 0.5);
      }

      .siri-inner {
        width: 120px;
        height: 120px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      }

      .siri-icon {
        font-size: 3em;
        color: white;
      }

      /* Animations */
      @keyframes gradientShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      @keyframes pulseActive {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.08);
        }
      }

      /* Instruction Text */
      .instruction-text {
        color: #6e6e73;
        font-size: 1.1em;
        margin-top: 40px;
        font-weight: 400;
      }

      /* Integration Popup */
      .integration-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
        z-index: 1000;
      }

      .popup-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .popup-title {
        font-size: 1.8em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 10px;
      }

      .popup-subtitle {
        color: #6e6e73;
        margin-bottom: 30px;
        font-size: 1em;
      }

      .integration-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        margin: 10px 0;
        background: #f8f9fa;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .integration-item:hover {
        background: #e3f2fd;
        border-color: #007aff;
        transform: translateY(-2px);
      }

      .integration-icon {
        font-size: 1.5em;
        margin-right: 15px;
        width: 30px;
        text-align: center;
      }

      .integration-name {
        flex: 1;
        text-align: left;
        font-weight: 500;
        color: #1d1d1f;
      }

      .close-popup {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        font-size: 1.5em;
        color: #6e6e73;
        cursor: pointer;
        padding: 5px;
      }

      .close-popup:hover {
        color: #1d1d1f;
      }
    </style>
  </head>
  <body>
    <!-- Integration Button - Top Right -->
    <button class="integration-btn" onclick="openIntegrationPopup()">
      Integrate with apps
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <h1 class="welcome-title">Well come to Vocal Agent!</h1>
      <p class="welcome-subtitle">what do you need help with?</p>

      <!-- Siri-like Animated Circle -->
      <div class="siri-container">
        <div class="siri-circle" id="siriCircle" onclick="toggleListening()">
          <div class="siri-inner">
            <div class="siri-icon">ðŸŽ¤</div>
          </div>
        </div>
      </div>

      <p class="instruction-text" id="instructionText">
        Click to start listening, click again to stop
      </p>
    </div>

    <!-- Integration Popup -->
    <div class="integration-popup" id="integrationPopup">
      <div class="popup-content">
        <button class="close-popup" onclick="closeIntegrationPopup()">âœ•</button>
        <h2 class="popup-title">Integrate With Apps</h2>
        <p class="popup-subtitle">Integrate with 3rd party apps:</p>

        <div
          class="integration-item"
          onclick="handleIntegration('Google Calendar')"
        >
          <div class="integration-icon">ðŸ“…</div>
          <div class="integration-name">Google Calendar</div>
        </div>

        <div class="integration-item" onclick="handleIntegration('Notes')">
          <div class="integration-icon">ï¿½</div>
          <div class="integration-name">Notes</div>
        </div>

        <div class="integration-item" onclick="handleIntegration('Gmail')">
          <div class="integration-icon">ðŸ“§</div>
          <div class="integration-name">Gmail</div>
        </div>

        <div class="integration-item" onclick="handleIntegration('Spotify')">
          <div class="integration-icon">ðŸŽµ</div>
          <div class="integration-name">Spotify</div>
        </div>
      </div>
    </div>

    <script>
      let isListening = false
      let recognition = null
      let finalTranscript = ''

      // Initialize Web Speech API
      function initializeSpeechRecognition() {
        try {
          // Check for browser support
          const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition

          if (!SpeechRecognition) {
            console.error('Speech recognition not supported in this browser')
            return false
          }

          recognition = new SpeechRecognition()
          recognition.continuous = true
          recognition.interimResults = true
          recognition.lang = 'en-US'

          recognition.onstart = () => {
            console.log('Speech recognition started')
          }

          recognition.onresult = (event) => {
            let interimTranscript = ''
            finalTranscript = ''

            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript
              if (event.results[i].isFinal) {
                finalTranscript += transcript
              } else {
                interimTranscript += transcript
              }
            }

            console.log('Interim:', interimTranscript)
            console.log('Final so far:', finalTranscript)
          }

          recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error)
          }

          recognition.onend = () => {
            console.log('Speech recognition ended')
            if (finalTranscript.trim()) {
              processTranscribedText(finalTranscript.trim())
            }
          }

          return true
        } catch (error) {
          console.error('Error initializing speech recognition:', error)
          return false
        }
      }

      // Toggle listening state for Siri circle
      function toggleListening() {
        const siriCircle = document.getElementById('siriCircle')
        const instructionText = document.getElementById('instructionText')

        if (!isListening) {
          // Start listening
          if (!recognition && !initializeSpeechRecognition()) {
            alert('Speech recognition not supported or failed to initialize')
            return
          }

          finalTranscript = ''
          recognition.start()
          isListening = true
          siriCircle.classList.add('listening')
          instructionText.textContent =
            'Listening... Click again to stop and process'
          console.log('Started listening...')
        } else {
          // Stop listening and start processing
          recognition.stop()
          isListening = false
          siriCircle.classList.remove('listening')
          instructionText.textContent = 'Processing your voice command...'
          console.log('Stopped listening, starting processing...')
        }
      }

      // Process transcribed text through the voice pipeline
      async function processTranscribedText(transcribedText) {
        try {
          console.log('Processing speech through voice pipeline...')
          console.log('Transcribed:', transcribedText)

          // Step 1: Refine speech with Gemini
          const refinement = await refineSpeech(transcribedText)
          if (!refinement.success) {
            throw new Error(refinement.error)
          }

          console.log('Refined:', refinement.refined_command)

          // Step 2: Process with ASI:One
          const processing = await processCommand(refinement.refined_command)
          if (!processing.success) {
            throw new Error(processing.error)
          }

          console.log('ASI:One Response:', processing.asi_one_response)

          // Show results to user
          displayResults({
            raw_speech: transcribedText,
            refined_command: refinement.refined_command,
            asi_response: processing.asi_one_response,
          })

          // Reset instruction text
          document.getElementById('instructionText').textContent =
            'Click to start listening, click again to stop â€¢ Cmd+Space works too'
        } catch (error) {
          console.error('Voice processing error:', error)
          alert(`Voice processing failed: ${error.message}`)

          // Reset instruction text on error
          document.getElementById('instructionText').textContent =
            'Click to start listening, click again to stop â€¢ Cmd+Space works too'
        }
      }

      // Speech recognition now handled by Web Speech API above

      // Call Gemini refinement API
      async function refineSpeech(rawSpeech) {
        const response = await fetch('/api/refine-speech', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ raw_speech: rawSpeech }),
        })
        return await response.json()
      }

      // Call ASI:One processing API
      async function processCommand(refinedCommand) {
        const response = await fetch('/api/process-command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refined_command: refinedCommand }),
        })
        return await response.json()
      }

      // Display results to user
      function displayResults(results) {
        // Create a temporary display area for results
        const existingResults = document.getElementById('voice-results')
        if (existingResults) {
          existingResults.remove()
        }

        const resultsDiv = document.createElement('div')
        resultsDiv.id = 'voice-results'
        resultsDiv.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 20px;
          right: 20px;
          background: white;
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          max-height: 300px;
          overflow-y: auto;
          z-index: 999;
        `

        resultsDiv.innerHTML = `
          <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
          <h3 style="margin: 0 0 15px 0; color: #333;">Voice Processing Results</h3>
          <div style="margin-bottom: 10px;">
            <strong>Raw Speech:</strong> "${results.raw_speech}"
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Refined Command:</strong> "${results.refined_command}"
          </div>
          <div>
            <strong>AI Response:</strong> ${results.asi_response.suggested_action}
          </div>
        `

        document.body.appendChild(resultsDiv)

        // Auto-remove after 10 seconds
        setTimeout(() => {
          if (document.getElementById('voice-results')) {
            resultsDiv.remove()
          }
        }, 10000)
      }

      // Integration popup functions
      function openIntegrationPopup() {
        const popup = document.getElementById('integrationPopup')
        popup.style.display = 'flex'
      }

      function closeIntegrationPopup() {
        const popup = document.getElementById('integrationPopup')
        popup.style.display = 'none'
      }

      // Handle integration clicks
      function handleIntegration(appName) {
        console.log(`click on Integration: ${appName}`)
        alert(`click on Integration: ${appName}`)
        closeIntegrationPopup()
      }

      // Close popup when clicking outside
      document
        .getElementById('integrationPopup')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeIntegrationPopup()
          }
        })

      // Keyboard shortcut listener (cmd + space)
      document.addEventListener('keydown', function (e) {
        if ((e.metaKey || e.ctrlKey) && e.code === 'Space') {
          e.preventDefault()
          toggleListening()
        }
      })

      // Update instruction text to include keyboard shortcut
      document.addEventListener('DOMContentLoaded', function () {
        const instructionText = document.getElementById('instructionText')
        instructionText.textContent =
          'Click to start listening, click again to stop â€¢ Cmd+Space works too'
      })

    //   // API functions (keeping for backend integration)
    //   async function testAPI() {
    //     try {
    //       const response = await fetch('/api/health')
    //       const data = await response.json()
    //       console.log('API Health Check:', data)
    //     } catch (error) {
    //       console.error('API Error:', error.message)
    //     }
    //   }

    //   async function simulateVoiceCommand() {
    //     const testCommand = 'Schedule a meeting for tomorrow at 2 PM'
    //     try {
    //       const response = await fetch('/api/process_voice', {
    //         method: 'POST',
    //         headers: {
    //           'Content-Type': 'application/json',
    //         },
    //         body: JSON.stringify({ command: testCommand }),
    //       })
    //       const data = await response.json()
    //       console.log('Voice Command Response:', data)

    //       // Stop listening after processing
    //       setTimeout(() => {
    //         const siriCircle = document.getElementById('siriCircle')
    //         siriCircle.classList.remove('listening')
    //         isListening = false
    //       }, 2000)
    //     } catch (error) {
    //       console.error('Voice Command Error:', error.message)
    //     }
    //   }
    </script>
  </body>
</html>
