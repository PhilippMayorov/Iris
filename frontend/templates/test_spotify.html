<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #1db954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #1ed760;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>üéµ Spotify Integration Test</h1>
    
    <div class="test-section">
        <h2>1. Test Auth Endpoint</h2>
        <button class="button" onclick="testAuthEndpoint()">Test /api/spotify/auth</button>
        <div id="authResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Callback Endpoint</h2>
        <button class="button" onclick="testCallbackEndpoint()">Test /api/spotify/callback</button>
        <div id="callbackResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Start Spotify OAuth</h2>
        <button class="button" onclick="startSpotifyAuth()">Start Spotify Authentication</button>
        <div id="oauthResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Check URL Parameters</h2>
        <button class="button" onclick="checkUrlParams()">Check Current URL Parameters</button>
        <div id="urlResult" class="result" style="display: none;"></div>
    </div>

    <script>
        async function testAuthEndpoint() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing...';
            
            try {
                const response = await fetch('/api/spotify/auth');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Success!\n\nAuth URL: ${data.auth_url}\n\nMessage: ${data.message}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Network Error: ${error.message}`;
            }
        }
        
        async function testCallbackEndpoint() {
            const resultDiv = document.getElementById('callbackResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing...';
            
            try {
                const response = await fetch('/api/spotify/callback?code=test_code');
                
                if (response.redirected) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Redirect successful!\n\nRedirected to: ${response.url}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå No redirect occurred. Status: ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Network Error: ${error.message}`;
            }
        }
        
        async function startSpotifyAuth() {
            const resultDiv = document.getElementById('oauthResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Starting OAuth...';
            
            try {
                const response = await fetch('/api/spotify/auth');
                const data = await response.json();
                
                if (data.success && data.auth_url) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ OAuth URL generated!\n\nRedirecting to: ${data.auth_url}`;
                    
                    // Redirect to Spotify
                    window.location.href = data.auth_url;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Failed to get OAuth URL: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Network Error: ${error.message}`;
            }
        }
        
        function checkUrlParams() {
            const resultDiv = document.getElementById('urlResult');
            resultDiv.style.display = 'block';
            
            const urlParams = new URLSearchParams(window.location.search);
            const spotifyAuth = urlParams.get('spotify_auth');
            
            let result = `Current URL: ${window.location.href}\n\n`;
            result += `URL Parameters:\n`;
            
            for (const [key, value] of urlParams.entries()) {
                result += `  ${key}: ${value}\n`;
            }
            
            if (spotifyAuth) {
                if (spotifyAuth === 'success') {
                    resultDiv.className = 'result success';
                    result += `\nüéâ Spotify authentication was successful!`;
                } else if (spotifyAuth === 'error') {
                    resultDiv.className = 'result error';
                    result += `\n‚ùå Spotify authentication failed!`;
                } else {
                    resultDiv.className = 'result';
                    result += `\n‚ö†Ô∏è Unknown spotify_auth value: ${spotifyAuth}`;
                }
            } else {
                resultDiv.className = 'result';
                result += `\n‚ÑπÔ∏è No spotify_auth parameter found.`;
            }
            
            resultDiv.textContent = result;
        }
        
        // Check URL parameters on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const spotifyAuth = urlParams.get('spotify_auth');
            
            if (spotifyAuth) {
                checkUrlParams();
            }
        });
    </script>
</body>
</html>
